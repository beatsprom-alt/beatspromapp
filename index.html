const firebaseConfig = {
        apiKey: "AIzaSyD9cxLlpJjgFcsDvNiGwbuevlvGhFLdLqI",
        authDomain: "beatspromapp.firebaseapp.com",
        databaseURL: "https://beatspromapp-default-rtdb.firebaseio.com",
        projectId: "beatspromapp",
        storageBucket: "beatspromapp.firebasestorage.app",
        messagingSenderId: "910279230250",
        appId: "1:910279230250:web:43e40e8450589b230a5453"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready(); // Сообщаем Telegram, что приложение готово

    const userId = String(tg.initDataUnsafe?.user?.id || "test_user");
    const userName = tg.initDataUnsafe?.user?.first_name || "Member";
    const rawParam = tg.initDataUnsafe?.start_param;
    const referrerId = rawParam ? String(rawParam) : null; 

    document.getElementById('username').innerText = userName;

    function showTab(tabId, el) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        el.classList.add('active');
        if(tabId === 'top') loadLeaderboard();
    }

    function generateRefLink() {
        const botUsername = "BeatspromBot"; 
        document.getElementById('ref-link').value = `https://t.me/${botUsername}?start=${userId}`;
    }

    function copyRefLink() {
        const linkInput = document.getElementById('ref-link');
        linkInput.select();
        navigator.clipboard.writeText(linkInput.value);
        tg.showAlert("Link copied!");
    }

    function loadLeaderboard() {
        database.ref('users').orderByChild('balance').limitToLast(10).once('value', (snapshot) => {
            const listDiv = document.getElementById('leaderboard-list');
            listDiv.innerHTML = '';
            let leaders = [];
            snapshot.forEach((child) => { leaders.push(child.val()); });
            leaders.reverse().forEach((leader, index) => {
                listDiv.innerHTML += `
                    <div class="leader-item">
                        <span class="leader-name">${index + 1}. ${leader.name || 'Incognito'}</span>
                        <span class="leader-score">${Math.floor(leader.balance || 0)} XP</span>
                    </div>`;
            });
        });
    }

    const FARM_DURATION = 8 * 60 * 60 * 1000;
    const REWARD_PER_SEC = 0.01;
    let farmInterval;

    function initApp() {
        generateRefLink();
        const userRef = database.ref('users/' + userId);
        
        // Тайм-аут для защиты от бесконечной загрузки
        const connectionTimeout = setTimeout(() => {
            if (document.getElementById('loading-text').style.display !== 'none') {
                document.getElementById('loading-text').innerText = "CONNECTION SLOW... RETRYING";
            }
        }, 5000);

        userRef.once('value').then((snapshot) => {
            clearTimeout(connectionTimeout);
            const data = snapshot.val();
            document.getElementById('loading-text').style.display = 'none';
            
            if (!data) {
                const newUser = { 
                    name: userName, 
                    balance: 500, 
                    startTime: "null",
                    invitedBy: referrerId || "none",
                    rewardGiven: false
                };
                userRef.set(newUser).then(() => updateUI(newUser));
            } else {
                updateUI(data);
            }
        }).catch(err => {
            document.getElementById('loading-text').innerText = "ERROR: CHECK INTERNET";
            console.error(err);
        });

        userRef.on('value', (snapshot) => {
            if (snapshot.exists()) updateUI(snapshot.val());
        });
    }

    function updateUI(data) {
        // Убираем точки и ставим реальный баланс
        document.getElementById('main-balance').innerText = Math.floor(data.balance || 0);
        
        if (data.startTime && data.startTime !== "null") {
            const elapsed = Date.now() - data.startTime;
            if (elapsed >= FARM_DURATION) { 
                showClaimButton(); 
            } else { 
                resumeFarming(data.startTime); 
            }
        } else { 
            showStartButton(); 
        }
    }

    function startFarming() {
        const userRef = database.ref('users/' + userId);
        userRef.once('value').then((snap) => {
            const userData = snap.val();
            
            if (userData && userData.invitedBy && userData.invitedBy !== "none" && !userData.rewardGiven) {
                const rId = userData.invitedBy;
                if (rId !== userId) {
                    database.ref('users/' + rId).once('value').then((rSnap) => {
                        if (rSnap.exists()) {
                            const oldBal = Number(rSnap.val().balance) || 0;
                            database.ref('users/' + rId).update({ balance: oldBal + 2500 });
                            userRef.update({ rewardGiven: true });
                        }
                    });
                }
            }
            userRef.update({ startTime: Date.now() });
        });
    }

    function resumeFarming(startTime) {
        document.getElementById('farm-btn').style.display = 'none';
        document.getElementById('mining-info').style.display = 'block';
        if (farmInterval) clearInterval(farmInterval);
        
        farmInterval = setInterval(() => {
            const now = Date.now();
            const elapsed = now - startTime;
            const timeLeft = Math.max(0, FARM_DURATION - elapsed);
            
            document.getElementById('farm-amount').innerText = ((elapsed / 1000) * REWARD_PER_SEC).toFixed(2);
            document.getElementById('progress-fill').style.width = Math.min(100, (elapsed / FARM_DURATION) * 100) + '%';
            
            const h = Math.floor(timeLeft / 3600000);
            const m = Math.floor((timeLeft % 3600000) / 60000);
            const s = Math.floor((timeLeft % 60000) / 1000);
            document.getElementById('timer').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            
            if (elapsed >= FARM_DURATION) {
                clearInterval(farmInterval);
                showClaimButton();
            }
        }, 1000);
    }

    function showClaimButton() {
        document.getElementById('mining-info').style.display = 'none';
        const btn = document.getElementById('farm-btn');
        btn.style.display = 'block';
        btn.innerText = "CLAIM PRODUCTION";
        btn.onclick = () => {
            database.ref('users/' + userId).once('value').then(s => {
                const b = s.val().balance || 0;
                database.ref('users/' + userId).update({ 
                    balance: b + (FARM_DURATION/1000 * REWARD_PER_SEC), 
                    startTime: "null" 
                });
            });
        };
    }

    function showStartButton() {
        const btn = document.getElementById('farm-btn');
        btn.style.display = 'block';
        btn.innerText = "START PRODUCTION";
        document.getElementById('mining-info').style.display = 'none';
        btn.onclick = startFarming;
    }

    function forceOpen(url) { tg.openLink(url); }

    // Запуск
    initApp();
