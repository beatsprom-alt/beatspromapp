<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD9cxLlpJjgFcsDvNiGwbuevlvGhFLdLqI",
        authDomain: "beatspromapp.firebaseapp.com",
        databaseURL: "https://beatspromapp-default-rtdb.firebaseio.com",
        projectId: "beatspromapp",
        storageBucket: "beatspromapp.firebasestorage.app",
        messagingSenderId: "910279230250",
        appId: "1:910279230250:web:43e40e8450589b230a5453"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const tg = window.Telegram.WebApp;
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id || "test_user";
    const userName = tg.initDataUnsafe?.user?.first_name || "Member";
    // Получаем ID пригласившего из ссылки Telegram
    const referrerId = tg.initDataUnsafe?.start_param; 

    document.getElementById('username').innerText = userName;

    function showTab(tabId, el) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        el.classList.add('active');
    }

    function generateRefLink() {
        const botUsername = "BeatspromBot"; 
        const link = `https://t.me/${botUsername}?start=${userId}`;
        document.getElementById('ref-link').value = link;
    }

    function copyRefLink() {
        const linkInput = document.getElementById('ref-link');
        linkInput.select();
        navigator.clipboard.writeText(linkInput.value);
        tg.showAlert("Link copied!");
    }

    const FARM_DURATION = 8 * 60 * 60 * 1000;
    const REWARD_PER_SEC = 0.01;
    let farmInterval;

    function initApp() {
        generateRefLink();
        const userRef = database.ref('users/' + userId);
        
        userRef.once('value').then((snapshot) => {
            document.getElementById('loading-text').style.display = 'none';
            const data = snapshot.val();
            
            if (!data) {
                // ЛОГИКА ДЛЯ НОВОГО ПОЛЬЗОВАТЕЛЯ
                const newUser = { 
                    name: userName, 
                    balance: 500, 
                    startTime: "null" 
                };
                
                userRef.set(newUser);

                // Если пришел по рефералке и не сам от себя
                if (referrerId && referrerId !== userId.toString()) {
                    const refUserRef = database.ref('users/' + referrerId);
                    refUserRef.get().then((refSnapshot) => {
                        if (refSnapshot.exists()) {
                            const currentBalance = refSnapshot.val().balance || 0;
                            refUserRef.update({ 
                                balance: currentBalance + 2500 
                            });
                            console.log("Бонус 2500 XP начислен пригласившему: " + referrerId);
                        }
                    });
                }
                updateUI(newUser);
            } else {
                updateUI(data);
            }
        });

        // Подписываемся на изменения баланса в реальном времени
        userRef.on('value', (snapshot) => {
            if (snapshot.exists()) updateUI(snapshot.val());
        });
    }

    function updateUI(data) {
        document.getElementById('main-balance').innerText = Math.floor(data.balance);
        if (data.startTime && data.startTime !== "null") {
            const elapsed = Date.now() - data.startTime;
            if (elapsed >= FARM_DURATION) { showClaimButton(); } 
            else { resumeFarming(data.startTime); }
        } else { showStartButton(); }
    }

    function startFarming() {
        database.ref('users/' + userId).update({ startTime: Date.now() });
    }

    function resumeFarming(startTime) {
        document.getElementById('farm-btn').style.display = 'none';
        document.getElementById('mining-info').style.display = 'block';
        if (farmInterval) clearInterval(farmInterval);
        farmInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const timeLeft = Math.max(0, FARM_DURATION - elapsed);
            document.getElementById('farm-amount').innerText = ((elapsed / 1000) * REWARD_PER_SEC).toFixed(2);
            document.getElementById('progress-fill').style.width = Math.min(100, (elapsed / FARM_DURATION) * 100) + '%';
            if (elapsed >= FARM_DURATION) { clearInterval(farmInterval); showClaimButton(); }
        }, 1000);
    }

    function showClaimButton() {
        document.getElementById('mining-info').style.display = 'none';
        const btn = document.getElementById('farm-btn');
        btn.style.display = 'block';
        btn.innerText = "CLAIM PRODUCTION";
        btn.onclick = () => {
            const userRef = database.ref('users/' + userId);
            userRef.get().then(s => {
                const b = s.val().balance || 500;
                userRef.update({ balance: b + (FARM_DURATION/1000 * REWARD_PER_SEC), startTime: "null" });
            });
        };
    }

    function showStartButton() {
        const btn = document.getElementById('farm-btn');
        btn.style.display = 'block';
        btn.innerText = "START PRODUCTION";
        document.getElementById('mining-info').style.display = 'none';
        btn.onclick = startFarming;
    }

    function forceOpen(url) { tg.openLink(url); }

    initApp();
</script>
